<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wiwynn Visitor Analytics - Real-time Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="assets/libs/three.min.js"></script>
    <script src="assets/libs/chart.min.js"></script>
    <style>
        :root {
            --primary-color: #4285F4;
            /* Google Blue */
            --google-red: #EA4335;
            --google-yellow: #FBBC05;
            --google-green: #34A853;
            --bg-dark: #0a0e27;
            --glass-bg: rgba(15, 25, 50, 0.7);
            --glass-border: rgba(66, 133, 244, 0.3);
            --text-color: #e0f7ff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            color: var(--text-color);
            min-height: 100vh;
            overflow-x: hidden;
        }

        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }

        .dashboard-container {
            position: relative;
            z-index: 10;
            padding: 40px 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--glass-border);
        }

        .header h1 {
            font-size: 2rem;
            text-shadow: 0 0 10px rgba(0, 242, 255, 0.5);
        }

        .header p {
            color: #8aa;
            margin-top: 5px;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #00ff99;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .dot {
            width: 8px;
            height: 8px;
            background: #00ff99;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 255, 153, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(0, 255, 153, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(0, 255, 153, 0);
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.3);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 10px 0;
            text-shadow: 0 0 10px rgba(0, 242, 255, 0.5);
        }

        .stat-label {
            color: #8aa;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-change {
            font-size: 0.8rem;
            margin-top: 8px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 24px;
            transition: transform 0.3s;
        }

        .chart-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.2);
        }

        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-title {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: #fff;
            border-left: 4px solid var(--primary-color);
            padding-left: 10px;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .chart-container.tall {
            height: 400px;
        }

        canvas {
            max-width: 100%;
        }

        .error-msg {
            color: #ff3366;
            text-align: center;
            padding: 20px;
            background: rgba(255, 51, 102, 0.1);
            border: 1px solid #ff3366;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .nav-tabs {
            display: flex;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 50px;
            padding: 4px;
            border: 1px solid var(--glass-border);
        }

        .nav-tab {
            padding: 8px 24px;
            border-radius: 50px;
            border: none;
            background: transparent;
            color: #8aa;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .nav-tab.active {
            background: var(--primary-color);
            color: #fff;
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.4);
        }

        .btn-settings {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--glass-border);
            color: var(--text-color);
            padding: 8px 20px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-settings:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #fff;
        }

        .guest-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
            color: var(--text-color);
        }

        .guest-table th,
        .guest-table td {
            padding: 16px;
            text-align: center;
            vertical-align: middle;
        }

        .guest-table th:first-child,
        .guest-table td:first-child {
            text-align: left;
            padding-left: 24px;
        }

        .guest-table th {
            color: #8aa;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .guest-table tbody tr {
            background: rgba(255, 255, 255, 0.03);
            transition: background 0.2s;
        }

        .guest-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .guest-table td:first-child {
            border-top-left-radius: 12px;
            border-bottom-left-radius: 12px;
        }

        .guest-table td:last-child {
            border-top-right-radius: 12px;
            border-bottom-right-radius: 12px;
        }

        .status-badge {
            padding: 6px 16px;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
        }

        .status-in {
            background: rgba(52, 168, 83, 0.2);
            color: var(--google-green);
            border: 1px solid var(--google-green);
        }

        .status-out {
            background: rgba(255, 255, 255, 0.1);
            color: #8aa;
            border: 1px solid #8aa;
        }

        .btn-signout {
            background: rgba(234, 67, 53, 0.15);
            color: var(--google-red);
            border: 1px solid var(--google-red);
            padding: 6px 16px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
        }

        .btn-signout:hover {
            background: var(--google-red);
            color: #fff;
            box-shadow: 0 0 10px rgba(234, 67, 53, 0.4);
        }

        /* Modal Styles Reuse */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #101025;
            border: 1px solid var(--primary-color);
            padding: 40px;
            border-radius: 24px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 0 30px rgba(0, 242, 255, 0.2);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: #8aa;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.25);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 12px;
            color: #fff;
            font-size: 1rem;
        }

        .btn-primary {
            background: rgba(66, 133, 244, 0.1);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            box-shadow: 0 0 10px rgba(66, 133, 244, 0.1);
            border-radius: 50px;
        }

        .btn-primary:hover {
            background: var(--primary-color);
            color: #fff;
            box-shadow: 0 0 20px rgba(66, 133, 244, 0.4);
        }
    </style>
</head>

<body>
    <div id="canvas-container"></div>

    <div class="dashboard-container">
        <div class="header">
            <div>
                <h1>ç·¯ç©è¨ªå®¢æ•¸æ“šåˆ†æ</h1>
                <p>å³æ™‚å®‰å…¨ç›£æ§èˆ‡è¨ªå•ç®¡ç†</p>
            </div>
            <div style="display: flex; gap: 20px; align-items: center;">
                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="switchTab('overview')">ç¸½è¦½</button>
                    <button class="nav-tab" onclick="switchTab('guestList')">è¨ªå®¢åå–®</button>
                </div>
                <button class="btn-settings" onclick="openSettings()">âš™ï¸ è¨­å®š</button>
                <div class="live-indicator">
                    <div class="dot"></div>
                    ç³»çµ±é‹è¡Œä¸­
                </div>
            </div>
        </div>

        <!-- Overview Tab -->
        <div id="tab-overview">

            <!-- Key Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">ä»Šæ—¥è¨ªå®¢</div>
                    <div class="stat-value" id="stat-visitors">0</div>
                    <div class="stat-change" id="visitors-change" style="color: #00ff99;">â–² 12% è¼ƒæ˜¨æ—¥</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ç›®å‰åœ¨å ´äººæ•¸</div>
                    <div class="stat-value" id="stat-onsite">0</div>
                    <div class="stat-change" style="color: #8aa;">å®¹é‡: <span id="capacity">0</span>%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å¹³å‡è¨ªå•æ™‚é•·</div>
                    <div class="stat-value"><span id="avg-duration">1.5</span><span style="font-size: 1rem;">h</span>
                    </div>
                    <div class="stat-change" style="color: #00ff99;">â–² 8% æ•ˆç‡æå‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å®‰å…¨è­¦å ±</div>
                    <div class="stat-value" style="color: #ff3366;" id="stat-alerts">0</div>
                    <div class="stat-change" style="color: #00ff99;">ç³»çµ±æ­£å¸¸</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="charts-grid">
                <!-- Traffic Line Chart -->
                <div class="chart-card">
                    <div class="chart-title">è¨ªå®¢æµé‡ (24å°æ™‚)</div>
                    <div class="chart-container">
                        <canvas id="trafficChart"></canvas>
                    </div>
                </div>

                <!-- Department 3D Bar Chart -->
                <div class="chart-card">
                    <div class="chart-title">å„éƒ¨é–€è¨ªå•é‡ (3D)</div>
                    <div class="chart-container">
                        <canvas id="deptChart"></canvas>
                    </div>
                </div>

                <!-- Visitor Type Distribution -->
                <div class="chart-card">
                    <div class="chart-title">è¨ªå®¢é¡å‹åˆ†å¸ƒ</div>
                    <div class="chart-container">
                        <canvas id="typeChart"></canvas>
                    </div>
                </div>

                <!-- Peak Hours Radar -->
                <div class="chart-card">
                    <div class="chart-title">é«˜å³°æ™‚æ®µåˆ†æ</div>
                    <div class="chart-container">
                        <canvas id="peakHoursChart"></canvas>
                    </div>
                </div>

                <!-- Weekly Trend -->
                <div class="chart-card full-width">
                    <div class="chart-title">æ¯é€±è¨ªå®¢è¶¨å‹¢</div>
                    <div class="chart-container tall">
                        <canvas id="weeklyTrendChart"></canvas>
                    </div>
                </div>

                <!-- Purpose Breakdown -->
                <div class="chart-card">
                    <div class="chart-title">è¨ªå•ç›®çš„åˆ†æ</div>
                    <div class="chart-container">
                        <canvas id="purposeChart"></canvas>
                    </div>
                </div>
            </div>
        </div> <!-- End of tab-overview -->

        <!-- Guest List Tab -->
        <div id="tab-guestList" style="display: none;">
            <div class="chart-card full-width">
                <div class="chart-title">ä»Šæ—¥è¨ªå®¢åå–®</div>
                <div style="overflow-x: auto;">
                    <table class="guest-table">
                        <thead>
                            <tr>
                                <th>å§“å</th>
                                <th>é¡å‹</th>
                                <th>å…¬å¸</th>
                                <th>æ¨“å±¤</th>
                                <th>æ‹œè¨ªå°è±¡</th>
                                <th>å…¥å ´æ™‚é–“</th>
                                <th>é›¢å ´æ™‚é–“</th>
                                <th>ç‹€æ…‹</th>
                            </tr>
                        </thead>
                        <tbody id="guestTableBody">
                            <!-- JS Injected -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div class="modal" id="settingsModal">
            <div class="modal-content">
                <h2 style="color: #fff; margin-bottom: 20px;">ç³»çµ±è¨­å®š</h2>
                <div class="form-group" style="text-align: left;">
                    <label class="form-label">æ¯æ—¥å ±è¡¨ç™¼é€æ™‚é–“</label>
                    <input type="time" id="reportTime" class="form-input" value="18:00">
                    <p style="font-size: 0.85rem; color: #8aa; margin-top: 5px;">
                        ç³»çµ±å°‡æ–¼æ­¤æ™‚é–“æª¢æŸ¥æœªç°½é€€è¨ªå®¢ï¼Œä¸¦æ¨¡æ“¬ç™¼é€é€šçŸ¥çµ¦å—è¨ªè€…ã€‚
                    </p>
                </div>
                <div style="display: flex; gap: 10px; justify-content: center; margin-top: 30px;">
                    <button class="btn-primary" onclick="saveSettings()"
                        style="padding: 10px 30px; cursor: pointer;">å„²å­˜è¨­å®š</button>
                    <button class="btn-primary" onclick="closeSettings()"
                        style="padding: 10px 30px; background: transparent; cursor: pointer;">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== Three.js Background ==========
        const initThreeJS = () => {
            const container = document.getElementById('canvas-container');
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });

            renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);

            // Create particles (æ˜Ÿæ˜Ÿæ•ˆæœ)
            const particlesGeometry = new THREE.BufferGeometry();
            const particlesCount = 3000;
            const positions = new Float32Array(particlesCount * 3);
            const colors = new Float32Array(particlesCount * 3);
            const sizes = new Float32Array(particlesCount);

            // å‰µå»ºæ˜Ÿæ˜Ÿ
            for (let i = 0; i < particlesCount; i++) {
                const i3 = i * 3;
                positions[i3] = (Math.random() - 0.5) * 150;
                positions[i3 + 1] = (Math.random() - 0.5) * 150;
                positions[i3 + 2] = (Math.random() - 0.5) * 150;

                // æ˜Ÿæ˜Ÿé¡è‰²ï¼šç™½è‰²åˆ°é»ƒè‰²
                const starColors = [
                    new THREE.Color("#FFFFFF"),
                    new THREE.Color("#FFFFAA"),
                    new THREE.Color("#FFE4B5"),
                    new THREE.Color("#FFF8DC")
                ];
                const starColor = starColors[Math.floor(Math.random() * starColors.length)];
                colors[i3] = starColor.r;
                colors[i3 + 1] = starColor.g;
                colors[i3 + 2] = starColor.b;

                // æ˜Ÿæ˜Ÿå¤§å°
                sizes[i] = Math.random() * 0.3 + 0.1;
            }

            particlesGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            particlesGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            particlesGeometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));

            // å‰µå»ºæ˜Ÿæ˜Ÿæè³ªè²¼åœ–
            const textureCanvas = document.createElement('canvas');
            textureCanvas.width = 64;
            textureCanvas.height = 64;
            const ctx = textureCanvas.getContext('2d');

            // ç¹ªè£½æ˜Ÿæ˜Ÿå½¢ç‹€
            const gradient = ctx.createRadialGradient(32, 32, 0, 32, 32, 32);
            gradient.addColorStop(0, 'rgba(255,255,255,1)');
            gradient.addColorStop(0.3, 'rgba(255,255,255,0.8)');
            gradient.addColorStop(0.5, 'rgba(255,255,255,0.3)');
            gradient.addColorStop(1, 'rgba(255,255,255,0)');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 64, 64);

            // æ·»åŠ åå­—å…‰èŠ’
            ctx.fillStyle = 'rgba(255,255,255,0.8)';
            ctx.fillRect(30, 0, 4, 64);
            ctx.fillRect(0, 30, 64, 4);

            const texture = new THREE.CanvasTexture(textureCanvas);

            const material = new THREE.PointsMaterial({
                size: 0.5,
                vertexColors: true,
                transparent: true,
                opacity: 0.8,
                blending: THREE.AdditiveBlending,
                map: texture,
                sizeAttenuation: true
            });

            const particlesMesh = new THREE.Points(particlesGeometry, material);
            scene.add(particlesMesh);

            camera.position.z = 50;
            camera.position.y = 10;

            // Animation loop
            const clock = new THREE.Clock();
            const animate = () => {
                requestAnimationFrame(animate);
                const time = clock.getElapsedTime();

                // æ˜Ÿæ˜Ÿé–ƒçˆæ•ˆæœ
                const sizesArray = particlesGeometry.attributes.size.array;
                for (let i = 0; i < sizesArray.length; i++) {
                    sizesArray[i] = (Math.sin(time * 5 + i) + 1) * 0.15 + 0.1;
                }
                particlesGeometry.attributes.size.needsUpdate = true;

                // ç·©æ…¢æ—‹è½‰æ•´å€‹æ˜Ÿç©º
                particlesMesh.rotation.z = time * 0.02;
                particlesMesh.rotation.x = time * 0.01;

                renderer.render(scene, camera);
            };

            animate();

            // Handle window resize
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        };

        // ========== Mock Data Generator ==========
        const generateMockData = () => {
            return {
                todayVisitors: Math.floor(Math.random() * 50) + 100,
                currentOnsite: Math.floor(Math.random() * 30) + 20,
                avgDuration: (Math.random() * 1.5 + 1).toFixed(1),
                securityAlerts: Math.floor(Math.random() * 3),
                capacity: Math.floor(Math.random() * 30) + 40,

                hourlyTraffic: Array.from({ length: 10 }, () => Math.floor(Math.random() * 40) + 10),

                departments: {
                    labels: ['ç ”ç™¼éƒ¨', 'æ¥­å‹™éƒ¨', 'äººè³‡éƒ¨', 'è³‡è¨Šéƒ¨', 'è²¡å‹™éƒ¨', 'è¡ŒéŠ·éƒ¨'],
                    data: Array.from({ length: 6 }, () => Math.floor(Math.random() * 50) + 20)
                },

                visitorTypes: {
                    labels: ['å» å•†', 'é¢è©¦è€…', 'å®¢æˆ¶', 'åˆä½œå¤¥ä¼´', 'å…¶ä»–'],
                    data: Array.from({ length: 5 }, () => Math.floor(Math.random() * 30) + 10)
                },

                peakHours: {
                    labels: ['8-10æ™‚', '10-12æ™‚', '12-14æ™‚', '14-16æ™‚', '16-18æ™‚', '18-20æ™‚'],
                    data: Array.from({ length: 6 }, () => Math.floor(Math.random() * 80) + 20)
                },

                weeklyTrend: {
                    labels: ['é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­', 'é€±æ—¥'],
                    visitors: Array.from({ length: 7 }, () => Math.floor(Math.random() * 80) + 60),
                    checkIns: Array.from({ length: 7 }, () => Math.floor(Math.random() * 70) + 50),
                    checkOuts: Array.from({ length: 7 }, () => Math.floor(Math.random() * 70) + 50)
                },

                purposes: {
                    labels: ['å•†å‹™æœƒè­°', 'æŠ€è¡“æ”¯æ´', 'é¢è©¦', 'åŸ¹è¨“', 'é€è²¨', 'å…¶ä»–'],
                    data: Array.from({ length: 6 }, () => Math.floor(Math.random() * 40) + 10)
                }
            };
        };

        // ========== Counter Animation ==========
        function animateValue(id, start, end, duration) {
            const obj = document.getElementById(id);
            if (!obj) return;

            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start);
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        // ========== Initialize Dashboard ==========
        const initDashboard = () => {
            initThreeJS();

            if (typeof Chart === 'undefined') {
                console.error('Chart.js not loaded');
                const container = document.querySelector('.dashboard-container');
                const errorMsg = document.createElement('div');
                errorMsg.className = 'error-msg';
                errorMsg.innerHTML = '<h2>âŒ Error: Chart.js failed to load</h2><p>Please check assets/libs/chart.min.js file path</p>';
                container.prepend(errorMsg);
                return;
            }

            // Chart.js global config
            Chart.defaults.color = '#8aa';
            Chart.defaults.borderColor = 'rgba(0, 242, 255, 0.1)';
            Chart.defaults.font.family = "'Inter', sans-serif";

            // Get mock data
            const data = generateMockData();

            // Update stats with animation
            animateValue("stat-visitors", 0, data.todayVisitors, 2000);
            animateValue("stat-onsite", 0, data.currentOnsite, 2000);
            animateValue("stat-alerts", 0, data.securityAlerts, 1500);
            animateValue("capacity", 0, data.capacity, 2000);

            document.getElementById('avg-duration').textContent = data.avgDuration;

            // ========== 1. Traffic Line Chart ==========
            new Chart(document.getElementById('trafficChart'), {
                type: 'line',
                data: {
                    labels: ['8é»', '9é»', '10é»', '11é»', '12é»', '14é»', '15é»', '16é»', '17é»', '18é»'],
                    datasets: [{
                        label: 'è¨ªå®¢æ•¸',
                        data: data.hourlyTraffic,
                        borderColor: '#00f2ff',
                        backgroundColor: 'rgba(0, 242, 255, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 25, 50, 0.9)',
                            borderColor: '#00f2ff',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 242, 255, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });

            // ========== 2. Department 3D Bar Chart ==========
            new Chart(document.getElementById('deptChart'), {
                type: 'bar',
                data: {
                    labels: data.departments.labels,
                    datasets: [{
                        label: 'è¨ªå•æ¬¡æ•¸',
                        data: data.departments.data,
                        backgroundColor: [
                            'rgba(0, 242, 255, 0.8)',
                            'rgba(0, 102, 255, 0.8)',
                            'rgba(153, 51, 255, 0.8)',
                            'rgba(255, 51, 102, 0.8)',
                            'rgba(0, 255, 153, 0.8)',
                            'rgba(255, 204, 0, 0.8)'
                        ],
                        borderColor: [
                            '#00f2ff',
                            '#0066ff',
                            '#9933ff',
                            '#ff3366',
                            '#00ff99',
                            '#ffcc00'
                        ],
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 25, 50, 0.9)',
                            borderColor: '#00f2ff',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 242, 255, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });

            // ========== 3. Type Doughnut Chart ==========
            new Chart(document.getElementById('typeChart'), {
                type: 'doughnut',
                data: {
                    labels: data.visitorTypes.labels,
                    datasets: [{
                        data: data.visitorTypes.data,
                        backgroundColor: [
                            '#00f2ff',
                            '#0066ff',
                            '#9933ff',
                            '#ff3366',
                            '#666'
                        ],
                        borderWidth: 2,
                        borderColor: '#0a0e27'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#8aa',
                                padding: 15,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 25, 50, 0.9)',
                            borderColor: '#00f2ff',
                            borderWidth: 1
                        }
                    }
                }
            });

            // ========== 4. Peak Hours Radar Chart ==========
            new Chart(document.getElementById('peakHoursChart'), {
                type: 'radar',
                data: {
                    labels: data.peakHours.labels,
                    datasets: [{
                        label: 'æ´»å‹•é‡',
                        data: data.peakHours.data,
                        borderColor: '#00f2ff',
                        backgroundColor: 'rgba(0, 242, 255, 0.2)',
                        borderWidth: 2,
                        pointBackgroundColor: '#00f2ff',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#00f2ff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 25, 50, 0.9)',
                            borderColor: '#00f2ff',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 242, 255, 0.2)'
                            },
                            angleLines: {
                                color: 'rgba(0, 242, 255, 0.2)'
                            },
                            ticks: {
                                backdropColor: 'transparent'
                            }
                        }
                    }
                }
            });

            // ========== 5. Weekly Trend Multi-line Chart ==========
            new Chart(document.getElementById('weeklyTrendChart'), {
                type: 'line',
                data: {
                    labels: data.weeklyTrend.labels,
                    datasets: [
                        {
                            label: 'ç¸½è¨ªå®¢æ•¸',
                            data: data.weeklyTrend.visitors,
                            borderColor: '#00f2ff',
                            backgroundColor: 'rgba(0, 242, 255, 0.1)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2
                        },
                        {
                            label: 'ç°½å…¥äººæ•¸',
                            data: data.weeklyTrend.checkIns,
                            borderColor: '#00ff99',
                            backgroundColor: 'rgba(0, 255, 153, 0.1)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2
                        },
                        {
                            label: 'ç°½å‡ºäººæ•¸',
                            data: data.weeklyTrend.checkOuts,
                            borderColor: '#ff3366',
                            backgroundColor: 'rgba(255, 51, 102, 0.1)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#8aa',
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 25, 50, 0.9)',
                            borderColor: '#00f2ff',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 242, 255, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });

            // ========== 6. Purpose Horizontal Bar Chart ==========
            new Chart(document.getElementById('purposeChart'), {
                type: 'bar',
                data: {
                    labels: data.purposes.labels,
                    datasets: [{
                        label: 'æ¬¡æ•¸',
                        data: data.purposes.data,
                        backgroundColor: 'rgba(0, 242, 255, 0.6)',
                        borderColor: '#00f2ff',
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 25, 50, 0.9)',
                            borderColor: '#00f2ff',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 242, 255, 0.1)'
                            }
                        },
                        y: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });

            // ========== Auto-refresh data every 30 seconds ==========
            setInterval(() => {
                const newData = generateMockData();

                // Update stats
                document.getElementById('stat-visitors').textContent = newData.todayVisitors;
                document.getElementById('stat-onsite').textContent = newData.currentOnsite;
                document.getElementById('stat-alerts').textContent = newData.securityAlerts;
                document.getElementById('capacity').textContent = newData.capacity;
                document.getElementById('avg-duration').textContent = newData.avgDuration;

                console.log('ğŸ“Š å„€è¡¨æ¿æ•¸æ“šå·²æ›´æ–°æ–¼ ' + new Date().toLocaleTimeString());

                // Also refresh guest list if active
                if (document.getElementById('tab-guestList').style.display !== 'none') {
                    renderGuestList();
                }

                checkDailyReport();
            }, 30000);

            // Initial render
            generateMockGuests(); // Generate 30 mock guests
            renderGuestList();

            // Check report time every minute
            setInterval(checkDailyReport, 60000);
        };

        // ========== New Features Logic ==========

        // 0. Mock Data Generator for Guest List
        function generateMockGuests() {
            // Only generate if empty
            const existing = JSON.parse(localStorage.getItem('wiwynn_guests') || '[]');
            if (existing.length > 0) return;

            const mockNames = ['John Doe', 'Jane Smith', 'Alice Johnson', 'Bob Brown', 'Charlie Davis', 'David Wilson', 'Eva Martinez', 'Frank Thomas', 'Grace Lee', 'Henry White'];
            const mockCompanies = ['Google', 'Microsoft', 'Apple', 'Amazon', 'Meta', 'Intel', 'Nvidia', 'AMD', 'Dell', 'HP'];
            const mockHosts = ['Alan Chen', 'Bob Lin', 'Debbie Wu', 'Max Wang', 'Demi Liu'];
            const mockFloors = ['A23', 'C26', 'C7', 'C8'];

            const newGuests = [];
            for (let i = 0; i < 30; i++) {
                const isOut = Math.random() > 0.5;
                const entryHour = Math.floor(Math.random() * 9) + 8; // 8am - 5pm
                const entryMin = Math.floor(Math.random() * 60);
                const entryTime = new Date();
                entryTime.setHours(entryHour, entryMin, 0);

                let exitTime = null;
                if (isOut) {
                    const exitHour = entryHour + Math.floor(Math.random() * 4) + 1;
                    const exitMin = Math.floor(Math.random() * 60);
                    const exitDate = new Date(entryTime);
                    exitDate.setHours(exitHour, exitMin, 0);
                    exitTime = exitDate.toLocaleString();
                }

                newGuests.push({
                    id: Date.now() + i,
                    name: mockNames[Math.floor(Math.random() * mockNames.length)] + ' ' + (i + 1),
                    company: mockCompanies[Math.floor(Math.random() * mockCompanies.length)],
                    phone: '09' + Math.floor(Math.random() * 100000000).toString().padStart(8, '0'),
                    floor: mockFloors[Math.floor(Math.random() * mockFloors.length)],
                    type: Math.random() > 0.3 ? 'Interviewer' : 'VIP',
                    hosts: mockHosts[Math.floor(Math.random() * mockHosts.length)],
                    photo: null,
                    entryTime: entryTime.toLocaleString(),
                    exitTime: exitTime
                });
            }

            localStorage.setItem('wiwynn_guests', JSON.stringify(newGuests));
        }

        // 1. Tab Switching
        window.switchTab = function (tabName) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            if (tabName === 'overview') {
                document.getElementById('tab-overview').style.display = 'block';
                document.getElementById('tab-guestList').style.display = 'none';
            } else {
                document.getElementById('tab-overview').style.display = 'none';
                document.getElementById('tab-guestList').style.display = 'block';
                renderGuestList();
            }
        };

        // 2. Guest List Rendering
        function renderGuestList() {
            const guests = JSON.parse(localStorage.getItem('wiwynn_guests') || '[]');
            const tbody = document.getElementById('guestTableBody');

            if (guests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:#8aa;">ç›®å‰ç„¡è¨ªå®¢è³‡æ–™</td></tr>';
                return;
            }

            // Sort by entry time desc
            guests.sort((a, b) => new Date(b.entryTime) - new Date(a.entryTime));

            tbody.innerHTML = guests.map(g => {
                const isOut = !!g.exitTime;
                const statusHtml = isOut
                    ? `<span class="status-badge status-out">å·²ç°½é€€</span>`
                    : `<span class="status-badge status-in">è¨ªå•ä¸­</span>`;

                const actionHtml = isOut
                    ? `-`
                    : `<button class="btn-signout" onclick="signOutGuest(${g.id})">ç°½é€€</button>`;

                return `
                    <tr>
                        <td>
                            <div style="font-weight:600;">${g.name}</div>
                            <div style="font-size:0.8rem; color:#8aa;">${g.phone}</div>
                        </td>
                        <td>${g.type === 'Interviewer' ? 'é¢è©¦è€…' : 'è²´è³“'}</td>
                        <td>${g.company}</td>
                        <td>${g.floor}</td>
                        <td>${g.hosts}</td>
                        <td>${g.entryTime}</td>
                        <td>${g.exitTime || '-'}</td>
                        <td>
                            <div style="display:flex; align-items:center; gap:10px;">
                                ${statusHtml}
                                ${actionHtml}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // 3. Sign Out
        window.signOutGuest = function (id) {
            if (!confirm('ç¢ºå®šè¦å°‡æ­¤è¨ªå®¢ç°½é€€å—ï¼Ÿ')) return;

            const guests = JSON.parse(localStorage.getItem('wiwynn_guests') || '[]');
            const idx = guests.findIndex(g => g.id === id);
            if (idx > -1) {
                guests[idx].exitTime = new Date().toLocaleString();
                localStorage.setItem('wiwynn_guests', JSON.stringify(guests));
                renderGuestList();
            }
        };

        // 4. Settings Modal
        window.openSettings = function () {
            document.getElementById('settingsModal').style.display = 'flex';
            const savedTime = localStorage.getItem('wiwynn_report_time') || '18:00';
            document.getElementById('reportTime').value = savedTime;
        };

        window.closeSettings = function () {
            document.getElementById('settingsModal').style.display = 'none';
        };

        window.saveSettings = function () {
            const time = document.getElementById('reportTime').value;
            localStorage.setItem('wiwynn_report_time', time);
            alert('è¨­å®šå·²å„²å­˜ï¼');
            closeSettings();
        };

        // 5. Daily Report Simulation
        function checkDailyReport() {
            const reportTime = localStorage.getItem('wiwynn_report_time') || '18:00';
            const now = new Date();
            const currentHourMin = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');

            // Simple check: if current time matches report time (within this minute)
            // In a real app, we'd have a flag to prevent multiple sends per day
            // Here we just check if we haven't alerted today
            const lastAlertDate = localStorage.getItem('wiwynn_last_alert_date');
            const todayStr = now.toDateString();

            if (currentHourMin === reportTime && lastAlertDate !== todayStr) {
                const guests = JSON.parse(localStorage.getItem('wiwynn_guests') || '[]');
                const activeGuests = guests.filter(g => !g.exitTime);

                if (activeGuests.length > 0) {
                    const names = activeGuests.map(g => g.name).join(', ');
                    alert(`[ç³»çµ±æ¨¡æ“¬ä¿¡ä»¶]\n\næ™‚é–“å·²é” ${reportTime}ã€‚\nä»¥ä¸‹è¨ªå®¢å°šæœªç°½é€€ï¼š\n${names}\n\nå·²è‡ªå‹•ç™¼é€æé†’ä¿¡ä»¶çµ¦ç›¸é—œå—è¨ªè€…ã€‚`);
                    localStorage.setItem('wiwynn_last_alert_date', todayStr);
                }
            }
        }

        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>

</html>