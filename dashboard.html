<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wiwynn Visitor Analytics - Real-time Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="assets/libs/three.min.js"></script>
    <script src="assets/libs/chart.min.js"></script>
    <style>
        :root {
            --primary-color: #4285F4;
            --google-red: #EA4335;
            --google-yellow: #FBBC04;
            --google-green: #34A853;
            --google-blue: #4285F4;
            --dark-bg: #0a0e27;
            --card-bg: rgba(15, 25, 50, 0.1);
            --text-primary: #fff;
            --text-secondary: #8aa;
            --border-color: rgba(0, 242, 255, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #000;
            color: var(--text-primary);
            overflow-x: hidden;
            min-height: 100vh;
        }

        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
            background: radial-gradient(circle at center, #1a1a3a 0%, #000 100%);
            opacity: 0.7;
        }

        .dashboard-container {
            position: relative;
            z-index: 1;
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 15px;
            border: 1px solid var(--border-color);
        }

        .header h1 {
            font-size: 2rem;
            background: linear-gradient(135deg, #00f2ff, #0066ff);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .nav-tab,
        .btn-settings,
        .btn-home {
            padding: 10px 24px;
            background: #303134;
            border: 1px solid #5f6368;
            color: #e8eaed;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            text-decoration: none;
        }

        .nav-tab:hover,
        .btn-settings:hover,
        .btn-home:hover {
            background: #4285F4;
            color: #ffffff;
            border-color: #4285F4;
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.4);
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: #4285F4;
            color: #ffffff;
            border-color: #4285F4;
            box-shadow: 0 0 15px rgba(66, 133, 244, 0.5);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 242, 255, 0.2);
            border-color: rgba(0, 242, 255, 0.5);
        }

        .stat-card h3 {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .stat-card .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #00f2ff;
            margin-bottom: 5px;
        }

        .stat-card .trend {
            font-size: 0.85rem;
            color: #00ff99;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .chart-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .chart-card:hover {
            border-color: rgba(0, 242, 255, 0.4);
            box-shadow: 0 5px 20px rgba(0, 242, 255, 0.15);
        }

        .chart-card h3 {
            font-size: 1rem;
            color: #00f2ff;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .chart-container {
            position: relative;
            height: 280px;
        }

        #tab-guestList {
            display: none;
        }

        .guest-table-container {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid var(--border-color);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            color: var(--text-primary);
        }

        table thead {
            background: rgba(0, 242, 255, 0.1);
        }

        table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #00f2ff;
            border-bottom: 2px solid var(--border-color);
        }

        table td {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        table tr:hover {
            background: rgba(0, 242, 255, 0.05);
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-in {
            background: rgba(0, 255, 153, 0.2);
            color: #00ff99;
            border: 1px solid #00ff99;
        }

        .status-out {
            background: rgba(255, 51, 102, 0.2);
            color: #ff3366;
            border: 1px solid #ff3366;
        }

        .btn-signout {
            padding: 6px 16px;
            background: linear-gradient(135deg, #ff3366, #ff6699);
            border: none;
            border-radius: 20px;
            color: #fff;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .btn-signout:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 51, 102, 0.4);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            max-width: 500px;
            width: 90%;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: #00f2ff;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: #00f2ff;
            box-shadow: 0 0 10px rgba(0, 242, 255, 0.3);
        }

        .btn-primary {
            padding: 12px 30px;
            background: linear-gradient(135deg, #00f2ff, #0066ff);
            border: none;
            border-radius: 25px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 242, 255, 0.4);
        }

        @media (max-width: 768px) {

            .stats-grid,
            .charts-grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 15px;
            }

            .nav-tabs {
                flex-wrap: wrap;
            }
        }
    </style>
</head>

<body>
    <div id="canvas-container"></div>

    <div class="dashboard-container">
        <div class="header">
            <h1>è¨ªå®¢æ•¸æ“šåˆ†æ</h1>
            <div class="nav-tabs">
                <button class="btn-home" onclick="window.location.href='index.html'">ğŸ  å›é¦–é </button>
                <button class="nav-tab active" onclick="switchTab('overview')">ç¸½è¦½</button>
                <button class="nav-tab" onclick="switchTab('guests')">è¨ªå®¢åå–®</button>
                <button class="btn-settings" onclick="openSettings()">âš™ï¸ è¨­å®š</button>
            </div>
        </div>

        <div id="tab-overview">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>ä»Šæ—¥è¨ªå®¢</h3>
                    <div class="value" id="stat-visitors">0</div>
                    <div class="trend">â–² 8% è¼ƒæ˜¨æ—¥</div>
                </div>
                <div class="stat-card">
                    <h3>å¹³å‡åœç•™æ™‚é–“</h3>
                    <div class="value"><span id="avg-duration">0</span>h</div>
                    <div class="trend">â–¼ 3% è¼ƒæ˜¨æ—¥</div>
                </div>
                <div class="stat-card">
                    <h3>å®‰å…¨è­¦å ±</h3>
                    <div class="value" id="stat-alerts">0</div>
                    <div class="trend">â–¼ 50% è¼ƒæ˜¨æ—¥</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <h3>è¨ªå®¢æµé‡ (24å°æ™‚)</h3>
                    <div class="chart-container">
                        <canvas id="trafficChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>å„éƒ¨é–€è¨ªå•çµ±è¨ˆ</h3>
                    <div class="chart-container">
                        <canvas id="deptChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>è¨ªå®¢é¡å‹åˆ†æ</h3>
                    <div class="chart-container">
                        <canvas id="typeChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>ç†±é–€æ™‚æ®µåˆ†æ</h3>
                    <div class="chart-container">
                        <canvas id="peakHoursChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>å³æ™‚æ´»å‹•ç´€éŒ„</h3>
                    <div id="activityLog" style="max-height: 280px; overflow-y: auto;"></div>
                </div>

                <div class="chart-card">
                    <h3>æ¯é€±è¶¨å‹¢</h3>
                    <div class="chart-container">
                        <canvas id="weeklyTrendChart"></canvas>
                    </div>
                </div>

                <div class="chart-card" style="grid-column: span 2;">
                    <h3>ä¾†è¨ªç›®çš„åˆ†æ</h3>
                    <div class="chart-container">
                        <canvas id="purposeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-guestList">
            <div class="guest-table-container">
                <h2 style="margin-bottom: 20px; color: #00f2ff;">è¨ªå®¢åå–®</h2>
                <table>
                    <thead>
                        <tr>
                            <th>è¨ªå®¢è³‡è¨Š</th>
                            <th>é¡å‹</th>
                            <th>å…¬å¸</th>
                            <th>æ¨“å±¤</th>
                            <th>å—è¨ªè€…</th>
                            <th>ç°½å…¥æ™‚é–“</th>
                            <th>ç°½é€€æ™‚é–“</th>
                            <th>ç‹€æ…‹/æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="guestTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h2 style="color: #fff; margin-bottom: 20px;">ç³»çµ±è¨­å®š</h2>
            <div class="form-group" style="text-align: left;">
                <label class="form-label">æ¯æ—¥å ±è¡¨ç™¼é€æ™‚é–“</label>
                <input type="time" id="reportTime" class="form-input" value="18:00">
                <p style="font-size: 0.85rem; color: #8aa; margin-top: 5px;">ç³»çµ±å°‡æ–¼æ­¤æ™‚é–“æª¢æŸ¥æœªç°½é€€è¨ªå®¢ï¼Œä¸¦æ¨¡æ“¬ç™¼é€é€šçŸ¥çµ¦å—è¨ªè€…ã€‚</p>
            </div>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 30px;">
                <button class="btn-primary" onclick="saveSettings()"
                    style="padding: 10px 30px; cursor: pointer;">å„²å­˜è¨­å®š</button>
                <button class="btn-primary" onclick="closeSettings()"
                    style="padding: 10px 30px; background: transparent; cursor: pointer;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // ========== Initialize Three.JS Background (Stars Only - Same as index.html) ==========
        function initThreeJS() {
            const container = document.getElementById('canvas-container');
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);

            const renderer = new THREE.WebGLRenderer({
                alpha: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);

            const particlesGeometry = new THREE.BufferGeometry();
            const particlesCount = 3000;
            const positions = new Float32Array(particlesCount * 3);
            const colors = new Float32Array(particlesCount * 3);
            const sizes = new Float32Array(particlesCount);

            for (let i = 0; i < particlesCount; i++) {
                const i3 = i * 3;
                positions[i3] = (Math.random() - 0.5) * 150;
                positions[i3 + 1] = (Math.random() - 0.5) * 150;
                positions[i3 + 2] = (Math.random() - 0.5) * 150;

                // White stars only (same as index.html)
                const starColor = new THREE.Color("#FFFFFF");
                colors[i3] = starColor.r;
                colors[i3 + 1] = starColor.g;
                colors[i3 + 2] = starColor.b;

                sizes[i] = Math.random() * 0.3 + 0.1;
            }

            particlesGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            particlesGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            particlesGeometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));

            // Create star texture with cross-shaped glow (same as index.html)
            const textureCanvas = document.createElement('canvas');
            textureCanvas.width = 64;
            textureCanvas.height = 64;
            const ctx = textureCanvas.getContext('2d');

            const gradient = ctx.createRadialGradient(32, 32, 0, 32, 32, 32);
            gradient.addColorStop(0, 'rgba(255,255,255,1)');
            gradient.addColorStop(0.3, 'rgba(255,255,255,0.8)');
            gradient.addColorStop(0.5, 'rgba(255,255,255,0.3)');
            gradient.addColorStop(1, 'rgba(255,255,255,0)');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 64, 64);

            // Add cross-shaped glow
            ctx.fillStyle = 'rgba(255,255,255,0.8)';
            ctx.fillRect(30, 0, 4, 64);
            ctx.fillRect(0, 30, 64, 4);

            const texture = new THREE.CanvasTexture(textureCanvas);

            const material = new THREE.PointsMaterial({
                size: 0.5,
                vertexColors: true,
                transparent: true,
                opacity: 0.8,
                blending: THREE.AdditiveBlending,
                map: texture,
                sizeAttenuation: true
            });

            const particlesMesh = new THREE.Points(particlesGeometry, material);
            scene.add(particlesMesh);

            camera.position.z = 50;
            camera.position.y = 10;

            const clock = new THREE.Clock();

            const animate = () => {
                requestAnimationFrame(animate);
                const time = clock.getElapsedTime();

                const sizesArray = particlesGeometry.attributes.size.array;

                for (let i = 0; i < sizesArray.length; i++) {
                    sizesArray[i] = (Math.sin(time * 5 + i) + 1) * 0.15 + 0.1;
                }

                particlesGeometry.attributes.size.needsUpdate = true;

                particlesMesh.rotation.z = time * 0.02;
                particlesMesh.rotation.x = time * 0.01;

                renderer.render(scene, camera);
            };

            animate();

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        // ========== Mock Data Generator ==========
        function generateMockData() {
            return {
                todayVisitors: Math.floor(Math.random() * 50) + 100,
                currentOnsite: Math.floor(Math.random() * 30) + 20,
                avgDuration: (Math.random() * 1.5 + 1).toFixed(1),
                securityAlerts: Math.floor(Math.random() * 3),
                capacity: Math.floor(Math.random() * 30) + 40,
                hourlyTraffic: Array.from({ length: 10 }, () => Math.floor(Math.random() * 40) + 10),
                departments: {
                    labels: ['ç ”ç™¼éƒ¨', 'æ¥­å‹™éƒ¨', 'äººè³‡éƒ¨', 'è³‡è¨Šéƒ¨', 'è²¡å‹™éƒ¨', 'è¡ŒéŠ·éƒ¨'],
                    data: Array.from({ length: 6 }, () => Math.floor(Math.random() * 50) + 20)
                },
                visitorTypes: {
                    labels: ['å» å•†', 'é¢è©¦è€…', 'å®¢æˆ¶', 'åˆä½œå¤¥ä¼´', 'å…¶ä»–'],
                    data: Array.from({ length: 5 }, () => Math.floor(Math.random() * 30) + 10)
                },
                peakHours: {
                    labels: ['8-10æ™‚', '10-12æ™‚', '12-14æ™‚', '14-16æ™‚', '16-18æ™‚', '18-20æ™‚'],
                    data: Array.from({ length: 6 }, () => Math.floor(Math.random() * 80) + 20)
                },
                weeklyTrend: {
                    labels: ['é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­', 'é€±æ—¥'],
                    visitors: Array.from({ length: 7 }, () => Math.floor(Math.random() * 80) + 60),
                    checkIns: Array.from({ length: 7 }, () => Math.floor(Math.random() * 70) + 50),
                    checkOuts: Array.from({ length: 7 }, () => Math.floor(Math.random() * 70) + 50)
                },
                purposes: {
                    labels: ['å•†å‹™æœƒè­°', 'æŠ€è¡“æ”¯æ´', 'é¢è©¦', 'åŸ¹è¨“', 'é€è²¨', 'å…¶ä»–'],
                    data: Array.from({ length: 6 }, () => Math.floor(Math.random() * 40) + 10)
                }
            };
        }

        // ========== Counter Animation ==========
        function animateValue(id, start, end, duration) {
            const obj = document.getElementById(id);
            if (!obj) return;
            let startTimestamp = null;

            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start);

                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        // ========== Mock Data Generator for Guest List ==========
        function generateMockGuests() {
            const existing = JSON.parse(localStorage.getItem('wiwynn_guests') || '[]');
            if (existing.length > 0) return;

            const mockNames = ['John Doe', 'Jane Smith', 'Alice Johnson', 'Bob Brown', 'Charlie Davis',
                'David Wilson', 'Eva Martinez', 'Frank Thomas', 'Grace Lee', 'Henry White'];
            const mockCompanies = ['Google', 'Microsoft', 'Apple', 'Amazon', 'Meta',
                'Intel', 'Nvidia', 'AMD', 'Dell', 'HP'];
            const mockHosts = ['Alan Chen', 'Bob Lin', 'Debbie Wu', 'Max Wang', 'Demi Liu'];
            const mockFloors = ['A23', 'C26', 'C7', 'C8'];

            const newGuests = [];

            for (let i = 0; i < 30; i++) {
                const isOut = Math.random() > 0.5;
                const entryHour = Math.floor(Math.random() * 9) + 8;
                const entryMin = Math.floor(Math.random() * 60);
                const entryTime = new Date();
                entryTime.setHours(entryHour, entryMin, 0);

                let exitTime = null;

                if (isOut) {
                    const exitHour = entryHour + Math.floor(Math.random() * 4) + 1;
                    const exitMin = Math.floor(Math.random() * 60);
                    const exitDate = new Date(entryTime);
                    exitDate.setHours(exitHour, exitMin, 0);
                    exitTime = exitDate.toLocaleString();
                }

                newGuests.push({
                    id: Date.now() + i,
                    name: mockNames[Math.floor(Math.random() * mockNames.length)] + ' ' + (i + 1),
                    company: mockCompanies[Math.floor(Math.random() * mockCompanies.length)],
                    phone: '09' + Math.floor(Math.random() * 100000000).toString().padStart(8, '0'),
                    floor: mockFloors[Math.floor(Math.random() * mockFloors.length)],
                    type: Math.random() > 0.3 ? 'Interviewer' : 'VIP',
                    hosts: mockHosts[Math.floor(Math.random() * mockHosts.length)],
                    photo: null,
                    entryTime: entryTime.toLocaleString(),
                    exitTime: exitTime
                });
            }

            localStorage.setItem('wiwynn_guests', JSON.stringify(newGuests));
        }

        // ========== Activity Log Rendering ==========
        function renderActivityLog() {
            const container = document.getElementById('activityLog');
            if (!container) return;

            const activities = [
                { type: 'in', msg: 'è¨ªå®¢ John Doe å·²ç°½å…¥', time: 'å‰›å‰›' },
                { type: 'out', msg: 'è¨ªå®¢ Jane Smith å·²ç°½é€€', time: '2åˆ†é˜å‰' },
                { type: 'alert', msg: 'åµæ¸¬åˆ°æœªæˆæ¬Šå€åŸŸé€²å…¥', time: '5åˆ†é˜å‰' },
                { type: 'in', msg: 'è¨ªå®¢ Alice Johnson å·²ç°½å…¥', time: '10åˆ†é˜å‰' },
                { type: 'in', msg: 'è¨ªå®¢ Bob Brown å·²ç°½å…¥', time: '15åˆ†é˜å‰' },
                { type: 'out', msg: 'è¨ªå®¢ Charlie Davis å·²ç°½é€€', time: '20åˆ†é˜å‰' },
                { type: 'in', msg: 'è¨ªå®¢ David Wilson å·²ç°½å…¥', time: '30åˆ†é˜å‰' },
                { type: 'alert', msg: 'ç³»çµ±è‡ªå‹•å‚™ä»½å®Œæˆ', time: '1å°æ™‚å‰' }
            ];

            if (Math.random() > 0.7) {
                const newActivity = {
                    type: Math.random() > 0.5 ? 'in' : 'out',
                    msg: `è¨ªå®¢ Guest_${Math.floor(Math.random() * 100)} å·²${Math.random() > 0.5 ? 'ç°½å…¥' : 'ç°½é€€'}`,
                    time: 'å‰›å‰›'
                };
                activities.unshift(newActivity);
                activities.pop();
            }

            container.innerHTML = activities.map(act => {
                let icon = 'ğŸŸ¢';
                let color = '#00ff99';

                if (act.type === 'out') { icon = 'ğŸ”´'; color = '#ff3366'; }
                if (act.type === 'alert') { icon = 'âš ï¸'; color = '#ffcc00'; }

                return `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                        <span style="font-size: 1.2rem;">${icon}</span>
                        <div style="flex: 1;">
                            <div style="color: #fff; font-size: 0.9rem;">${act.msg}</div>
                            <div style="color: #8aa; font-size: 0.8rem;">${act.time}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ========== Guest List Rendering ==========
        function renderGuestList() {
            const guests = JSON.parse(localStorage.getItem('wiwynn_guests') || '[]');
            const tbody = document.getElementById('guestTableBody');

            if (guests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:#8aa;">ç›®å‰ç„¡è¨ªå®¢è³‡æ–™</td></tr>';
                return;
            }

            guests.sort((a, b) => new Date(b.entryTime) - new Date(a.entryTime));

            tbody.innerHTML = guests.map(g => {
                const isOut = !!g.exitTime;
                const statusHtml = isOut ? `<span class="status-badge status-out">å·²ç°½é€€</span>` : `<span class="status-badge status-in">è¨ªå•ä¸­</span>`;
                const actionHtml = isOut ? `-` : `<button class="btn-signout" onclick="signOutGuest(${g.id})">ç°½é€€</button>`;

                return `
                    <tr>
                        <td>
                            <div style="font-weight:600;">${g.name}</div>
                            <div style="font-size:0.8rem; color:#8aa;">${g.phone}</div>
                        </td>
                        <td>${g.type === 'Interviewer' ? 'é¢è©¦è€…' : 'è²´è³“'}</td>
                        <td>${g.company}</td>
                        <td>${g.floor}</td>
                        <td>${g.hosts}</td>
                        <td>${g.entryTime}</td>
                        <td>${g.exitTime || '-'}</td>
                        <td>
                            <div style="display:flex; align-items:center; gap:10px;">
                                ${statusHtml}
                                ${actionHtml}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ========== Tab Switching ==========
        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            if (tabName === 'overview') {
                document.getElementById('tab-overview').style.display = 'block';
                document.getElementById('tab-guestList').style.display = 'none';
            } else {
                document.getElementById('tab-overview').style.display = 'none';
                document.getElementById('tab-guestList').style.display = 'block';
                renderGuestList();
            }
        }

        // ========== Sign Out ==========
        function signOutGuest(id) {
            if (!confirm('ç¢ºå®šè¦å°‡æ­¤è¨ªå®¢ç°½é€€å—ï¼Ÿ')) return;
            const guests = JSON.parse(localStorage.getItem('wiwynn_guests') || '[]');
            const idx = guests.findIndex(g => g.id === id);

            if (idx > -1) {
                guests[idx].exitTime = new Date().toLocaleString();
                localStorage.setItem('wiwynn_guests', JSON.stringify(guests));
                renderGuestList();
            }
        }

        // ========== Settings Modal ==========
        function openSettings() {
            document.getElementById('settingsModal').style.display = 'flex';
            const savedTime = localStorage.getItem('wiwynn_report_time') || '18:00';
            document.getElementById('reportTime').value = savedTime;
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function saveSettings() {
            const time = document.getElementById('reportTime').value;
            localStorage.setItem('wiwynn_report_time', time);
            alert('è¨­å®šå·²å„²å­˜ï¼');
            closeSettings();
        }

        // ========== Daily Report Simulation ==========
        function checkDailyReport() {
            const reportTime = localStorage.getItem('wiwynn_report_time') || '18:00';
            const now = new Date();
            const currentHourMin = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
            const lastAlertDate = localStorage.getItem('wiwynn_last_alert_date');
            const todayStr = now.toDateString();

            if (currentHourMin === reportTime && lastAlertDate !== todayStr) {
                const guests = JSON.parse(localStorage.getItem('wiwynn_guests') || '[]');
                const activeGuests = guests.filter(g => !g.exitTime);

                if (activeGuests.length > 0) {
                    const names = activeGuests.map(g => g.name).join(', ');
                    alert(`[ç³»çµ±æ¨¡æ“¬ä¿¡ä»¶]\n\næ™‚é–“å·²é” ${reportTime}ã€‚\nä»¥ä¸‹è¨ªå®¢å°šæœªç°½é€€ï¼š\n${names}\n\nå·²è‡ªå‹•ç™¼é€æé†’ä¿¡ä»¶çµ¦ç›¸é—œå—è¨ªè€…ã€‚`);
                    localStorage.setItem('wiwynn_last_alert_date', todayStr);
                }
            }
        }

        // ========== Initialize Dashboard ==========
        function initDashboard() {
            console.log('ğŸš€ Initializing dashboard...');

            initThreeJS();

            if (typeof Chart === 'undefined') {
                console.error('âŒ Chart.js not loaded');
                alert('éŒ¯èª¤ï¼šChart.js æœªè¼‰å…¥ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆè·¯å¾‘');
                return;
            }

            Chart.defaults.color = '#8aa';
            Chart.defaults.borderColor = 'rgba(0, 242, 255, 0.1)';
            Chart.defaults.font.family = "'Inter', sans-serif";

            const data = generateMockData();

            animateValue("stat-visitors", 0, data.todayVisitors, 2000);
            animateValue("stat-alerts", 0, data.securityAlerts, 1500);
            document.getElementById('avg-duration').textContent = data.avgDuration;

            // Traffic Chart
            new Chart(document.getElementById('trafficChart'), {
                type: 'line',
                data: {
                    labels: ['8é»', '9é»', '10é»', '11é»', '12é»', '14é»', '15é»', '16é»', '17é»', '18é»'],
                    datasets: [{
                        label: 'è¨ªå®¢æ•¸',
                        data: data.hourlyTraffic,
                        borderColor: '#00f2ff',
                        backgroundColor: 'rgba(0, 242, 255, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 25, 50, 0.9)',
                            borderColor: '#00f2ff',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0, 242, 255, 0.1)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });

            // Department Chart
            new Chart(document.getElementById('deptChart'), {
                type: 'bar',
                data: {
                    labels: data.departments.labels,
                    datasets: [{
                        label: 'è¨ªå•æ¬¡æ•¸',
                        data: data.departments.data,
                        backgroundColor: [
                            'rgba(0, 242, 255, 0.8)', 'rgba(0, 102, 255, 0.8)',
                            'rgba(153, 51, 255, 0.8)', 'rgba(255, 51, 102, 0.8)',
                            'rgba(0, 255, 153, 0.8)', 'rgba(255, 204, 0, 0.8)'
                        ],
                        borderColor: ['#00f2ff', '#0066ff', '#9933ff', '#ff3366', '#00ff99', '#ffcc00'],
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 25, 50, 0.9)',
                            borderColor: '#00f2ff',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0, 242, 255, 0.1)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });

            // Type Chart
            new Chart(document.getElementById('typeChart'), {
                type: 'doughnut',
                data: {
                    labels: data.visitorTypes.labels,
                    datasets: [{
                        data: data.visitorTypes.data,
                        backgroundColor: ['#00f2ff', '#0066ff', '#9933ff', '#ff3366', '#666'],
                        borderWidth: 2,
                        borderColor: '#0a0e27'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#8aa',
                                padding: 15,
                                font: { size: 11 }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 25, 50, 0.9)',
                            borderColor: '#00f2ff',
                            borderWidth: 1
                        }
                    }
                }
            });

            // Peak Hours Chart
            new Chart(document.getElementById('peakHoursChart'), {
                type: 'radar',
                data: {
                    labels: data.peakHours.labels,
                    datasets: [{
                        label: 'æ´»å‹•é‡',
                        data: data.peakHours.data,
                        borderColor: '#00f2ff',
                        backgroundColor: 'rgba(0, 242, 255, 0.2)',
                        borderWidth: 2,
                        pointBackgroundColor: '#00f2ff',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#00f2ff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 25, 50, 0.9)',
                            borderColor: '#00f2ff',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0, 242, 255, 0.2)' },
                            angleLines: { color: 'rgba(0, 242, 255, 0.2)' },
                            ticks: { backdropColor: 'transparent' }
                        }
                    }
                }
            });

            // Weekly Trend Chart
            new Chart(document.getElementById('weeklyTrendChart'), {
                type: 'line',
                data: {
                    labels: data.weeklyTrend.labels,
                    datasets: [
                        {
                            label: 'ç¸½è¨ªå®¢æ•¸',
                            data: data.weeklyTrend.visitors,
                            borderColor: '#00f2ff',
                            backgroundColor: 'rgba(0, 242, 255, 0.1)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2
                        },
                        {
                            label: 'ç°½å…¥äººæ•¸',
                            data: data.weeklyTrend.checkIns,
                            borderColor: '#00ff99',
                            backgroundColor: 'rgba(0, 255, 153, 0.1)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2
                        },
                        {
                            label: 'ç°½å‡ºäººæ•¸',
                            data: data.weeklyTrend.checkOuts,
                            borderColor: '#ff3366',
                            backgroundColor: 'rgba(255, 51, 102, 0.1)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#8aa',
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 25, 50, 0.9)',
                            borderColor: '#00f2ff',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0, 242, 255, 0.1)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });

            // Purpose Chart
            new Chart(document.getElementById('purposeChart'), {
                type: 'bar',
                data: {
                    labels: data.purposes.labels,
                    datasets: [{
                        label: 'æ¬¡æ•¸',
                        data: data.purposes.data,
                        backgroundColor: 'rgba(0, 242, 255, 0.6)',
                        borderColor: '#00f2ff',
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 25, 50, 0.9)',
                            borderColor: '#00f2ff',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0, 242, 255, 0.1)' }
                        },
                        y: {
                            grid: { display: false }
                        }
                    }
                }
            });

            setInterval(() => {
                const newData = generateMockData();
                document.getElementById('stat-visitors').textContent = newData.todayVisitors;
                document.getElementById('stat-alerts').textContent = newData.securityAlerts;
                document.getElementById('avg-duration').textContent = newData.avgDuration;
                console.log('ğŸ“Š å„€è¡¨æ¿æ•¸æ“šå·²æ›´æ–°æ–¼ ' + new Date().toLocaleTimeString());

                if (document.getElementById('tab-guestList').style.display !== 'none') {
                    renderGuestList();
                }

                checkDailyReport();
            }, 30000);

            generateMockGuests();
            renderGuestList();
            renderActivityLog();

            setInterval(checkDailyReport, 60000);
            setInterval(renderActivityLog, 5000);

            console.log('âœ… Dashboard initialized successfully!');
        }

        // Call initDashboard when the page is fully loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initDashboard);
        } else {
            initDashboard();
        }
    </script>
</body>

</html>